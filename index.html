<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Halloween Rock — Tap to Drum</title>
  <style>
    :root{--bg:#0b0b10;--card:#111217;--accent:#ffb86b;--muted:#808296;color-scheme:dark}
    html,body{height:100%;margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Helvetica Neue',Arial}
    body{background:linear-gradient(180deg,#06060a 0%, #12121a 100%);color:#fff;display:flex;align-items:stretch}
    .app{max-width:420px;margin:auto;width:100%;height:100vh;display:flex;flex-direction:column}
    .topbar{display:flex;justify-content:space-between;align-items:center;padding:12px}
    .coins{display:flex;gap:8px;align-items:center;font-weight:700}
    .coin-badge{background:linear-gradient(180deg,#ffd27a,#ffb86b);color:#111;padding:6px 10px;border-radius:20px}
    .play-area{flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:8px}
    .doodle{width:260px;height:340px;border-radius:16px;background:var(--card);display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:12px;box-shadow:0 6px 20px rgba(0,0,0,.6)}
    .face{width:120px;height:120px;border-radius:999px;background:#fff;background-size:cover;overflow:hidden;display:flex;align-items:center;justify-content:center}
    .face.smile{transform:translateY(-4px)}
    .face.surprised{transform:scale(0.98)}
    .drum-piece{margin-top:14px;width:200px;height:120px;background:linear-gradient(180deg,#222,#1a1a26);border-radius:8px;display:flex;align-items:center;justify-content:center;color:var(--muted)}
  .bottom{padding:14px;display:flex;flex-direction:column;gap:8px;align-items:center}
  .play-row{display:flex;gap:8px;justify-content:center;width:100%}
  .play-btn{background:var(--accent);border:0;padding:10px 14px;border-radius:10px;color:#111;font-weight:700}
  .small-play-btn{background:#2b2b33;border:0;padding:8px 10px;border-radius:8px;color:#fff}
    button{background:var(--accent);border:0;padding:10px 14px;border-radius:10px;color:#111;font-weight:700}
    .shop-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 12px;border-radius:10px;color:var(--muted)}
    /* modal */
    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;backdrop-filter:blur(3px)}
    .modal.open{display:flex}
    .modal-card{width:92%;max-width:420px;background:#0c0c10;border-radius:12px;padding:12px;box-shadow:0 10px 40px rgba(0,0,0,.6)}
    .item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px}
    .item.owned{opacity:.4}
    .items{display:flex;flex-direction:column;gap:6px;margin-top:8px}
    .small{font-size:12px;color:var(--muted)}
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="coins"> <span id="coinCount" class="coin-badge">0</span> <span class="small">coins</span></div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="openShop" class="shop-btn">Shop</button>
        <button id="clearCacheBtn" class="shop-btn">Clear cache</button>
      </div>
    </div>

    <main class="play-area">
      <div class="doodle" id="doodle">
        <div id="face" class="face" style="background-image: url('data:image/svg+xml;utf8,<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'120\' height=\'120\'><rect width=\'120\' height=\'120\' rx=\'60\' fill=\'%23f6e7d6\' /><circle cx=\'40\' cy=\'50\' r=\'6\' fill=\'%23000\' /><circle cx=\'80\' cy=\'50\' r=\'6\' fill=\'%23000\' /><path d=\'M38 80 Q60 95 82 80\' stroke=\'%23000\' stroke-width=3 fill=\'none\' stroke-linecap=\'round\' /></svg>')"></div>
        <div class="drum-piece" id="drumPiece">Basic drum</div>
      </div>
    </main>

    <div class="bottom">
      <div class="play-row">
        <button id="tapBtn" class="play-btn">Tap to Drum</button>
      </div>
      <div id="ownedPlayRow" class="play-row" style="display:none"></div>
    </div>
  </div>

  <div id="shopModal" class="modal">
    <div class="modal-card">
      <div style="display:flex;justify-content:space-between;align-items:center"><strong>Shop</strong><button id="closeShop" class="shop-btn">Close</button></div>
      <div class="items" id="itemsList"></div>
    </div>
  </div>

  <script>
    // Minimal vanilla prototype — local persistence, tap to play, shop
    const STORAGE_KEY = 'halloween-rock:v1'
  const defaultState = { coins: 0, owned: { drums: [], hats: [], memes: [] }, equipped: { drum: null, hat: null, meme: null }, version: 1 }

    function loadState(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || defaultState }catch(e){return defaultState} }
    function saveState(s){ localStorage.setItem(STORAGE_KEY, JSON.stringify(s)) }

    let state = loadState()
    const coinCount = document.getElementById('coinCount')
    const tapBtn = document.getElementById('tapBtn')
    const face = document.getElementById('face')
    const drumPiece = document.getElementById('drumPiece')
    const openShop = document.getElementById('openShop')
    const shopModal = document.getElementById('shopModal')
    const closeShop = document.getElementById('closeShop')
    const itemsList = document.getElementById('itemsList')

    const SHOP_ITEMS = [
      { id: 'snare', kind:'drum', name:'Snare', price: 10 },
      { id: 'tom', kind:'drum', name:'Tom', price: 20 },
      { id: 'hat', kind:'hat', name:'Spooky Hat', price: 15 },
      { id: 'meme1', kind:'meme', name:'Pumpkin Poster', price: 12 }
    ]

  function render(){ coinCount.textContent = state.coins; updateDrumVisual(); updateTapLabel(); renderOwnedPlayButtons() }

    function updateDrumVisual(){
      const equipped = state.equipped && state.equipped.drum
      if (equipped) {
        drumPiece.textContent = 'Drum kit: ' + equipped
      } else {
        const ownedDrums = state.owned.drums || []
        drumPiece.textContent = ownedDrums.length ? 'Drum kit: ' + ownedDrums.join(', ') : 'Basic drum'
      }
    }

    function updateTapLabel(){
      const equipped = state.equipped && state.equipped.drum
      tapBtn.textContent = equipped ? `Tap to Play (${equipped})` : 'Tap to Drum'
    }

    // simple WebAudio hit (short noise + pitch)
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)()
    function playInstrument(id){
      const freqMap = { snare: 220, tom: 150, basic: 120 }
      const freq = freqMap[id] || freqMap.basic
      const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
      o.type = 'square'; o.frequency.setValueAtTime(freq, audioCtx.currentTime);
      g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.4, audioCtx.currentTime + 0.01);
      g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.45);
      o.connect(g); g.connect(audioCtx.destination); o.start(); setTimeout(()=>o.stop(),160)
    }

    function giveCoin(n=1){ state.coins = (state.coins||0) + n; saveState(state); render() }

    tapBtn.addEventListener('click', ()=>{
      // ensure audio resumed on first interaction
      if(audioCtx.state === 'suspended') audioCtx.resume()
      const equipped = state.equipped && state.equipped.drum
      playInstrument(equipped || 'basic')
      face.classList.add('smile'); setTimeout(()=>face.classList.remove('smile'),160)
      giveCoin(1)
    })

    openShop.addEventListener('click', ()=>{ renderShop(); shopModal.classList.add('open') })
    closeShop.addEventListener('click', ()=>{ shopModal.classList.remove('open') })

    function renderShop(){
      itemsList.innerHTML = ''
      SHOP_ITEMS.forEach(it=>{
        const row = document.createElement('div'); row.className = 'item'
        const left = document.createElement('div'); left.innerHTML = `<div><strong>${it.name}</strong><div class='small'>${it.price} coins</div></div>`
        const right = document.createElement('div')
        const owned = (state.owned[it.kind+'s'] || []).includes(it.id)
        if (owned) {
          row.classList.add('owned')
          // show equipped state or equip button for owned items
          const isEquipped = state.equipped && state.equipped[it.kind] === it.id
          if (isEquipped) {
            right.innerHTML = '<span class="small">Equipped</span>'
          } else {
            const eq = document.createElement('button'); eq.textContent = 'Equip'; eq.addEventListener('click', ()=>{ equipItem(it) }); right.appendChild(eq)
          }
        } else {
          const b = document.createElement('button'); b.textContent = 'Buy'; b.addEventListener('click', ()=>{ buyItem(it) }); right.appendChild(b)
        }
        row.appendChild(left); row.appendChild(right); itemsList.appendChild(row)
      })
    }

    function buyItem(item){
      if (state.coins < item.price) { alert('Not enough coins'); return }
      state.coins -= item.price
      state.owned[item.kind+'s'] = state.owned[item.kind+'s'] || []
      if (!state.owned[item.kind+'s'].includes(item.id)) {
        state.owned[item.kind+'s'].push(item.id)
      }
      // Auto-equip newly purchased instrument/item of same kind
      state.equipped = state.equipped || { drum: null, hat: null, meme: null }
      state.equipped[item.kind] = item.id
      saveState(state)
      render()
      renderShop()
      // Keep shop open so user sees the item marked as Owned; show a small confirmation
      const toast = document.createElement('div')
      toast.textContent = 'Purchased!'
      toast.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#222;color:#fff;padding:8px 12px;border-radius:8px;z-index:9999'
      document.body.appendChild(toast)
      setTimeout(()=>toast.remove(),1200)
    }

    function equipItem(item){
      state.equipped = state.equipped || { drum: null, hat: null, meme: null }
      state.equipped[item.kind] = item.id
      saveState(state)
      render()
      renderShop()
    }

    // Render play buttons for owned instruments at the bottom
    function renderOwnedPlayButtons(){
      const row = document.getElementById('ownedPlayRow')
      row.innerHTML = ''
      const ownedDrums = state.owned.drums || []
      if (ownedDrums.length === 0){ row.style.display = 'none'; return }
      row.style.display = 'flex'
      ownedDrums.forEach(id => {
        const it = SHOP_ITEMS.find(s => s.id === id)
        const name = it ? it.name : id
        const b = document.createElement('button')
        b.className = 'small-play-btn'
        b.textContent = `Play ${name}`
        b.addEventListener('click', ()=>{
          if(audioCtx.state === 'suspended') audioCtx.resume()
          playInstrument(id)
          face.classList.add('smile'); setTimeout(()=>face.classList.remove('smile'),160)
          // no coins for playing via these buttons (they're for variety)
        })
        row.appendChild(b)
      })
    }

    // initial render
    render()

    // expose for debugging
    window._hr = { state, saveState, loadState }
  </script>

  <script>
    // Register service worker for offline caching (if supported)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').then(reg => {
          console.log('Service worker registered:', reg.scope)
          // If there's a waiting worker (new version), tell it to skip waiting so it activates
          if (reg.waiting) {
            reg.waiting.postMessage({ type: 'SKIP_WAITING' })
          }
        }).catch(err => console.warn('SW registration failed:', err))
      })
    }

    // Clear cache button (debug) — unregister service workers, clear caches and localStorage, then reload
    const clearCacheBtn = document.getElementById('clearCacheBtn')
    if (clearCacheBtn) {
      clearCacheBtn.addEventListener('click', async () => {
        try {
          // Unregister service workers
          const regs = await navigator.serviceWorker.getRegistrations()
          await Promise.all(regs.map(r => r.unregister()))
          // Delete caches
          const keys = await caches.keys()
          await Promise.all(keys.map(k => caches.delete(k)))
          // Clear game state
          localStorage.removeItem('halloween-rock:v1')
          // Show feedback and reload
          const t = document.createElement('div')
          t.textContent = 'Cache cleared — reloading...'
          t.style.cssText = 'position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#222;color:#fff;padding:8px 12px;border-radius:8px;z-index:9999'
          document.body.appendChild(t)
          setTimeout(() => location.reload(true), 600)
        } catch (e) {
          console.error('Clear cache failed', e)
          alert('Failed to clear cache: ' + e.message)
        }
      })
    }
  </script>
</body>
</html>
