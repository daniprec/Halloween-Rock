<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Halloween Rock â€” Pulsa para Tocar</title>
  <link rel="stylesheet" href="styles/main.css" />
</head>
<body>
  <div class="app">
    <div class="topbar">
      <div class="coins"> <span id="coinCount" class="coin-badge">0</span> <span class="small">Monedas</span></div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="openShop" class="shop-btn">Tienda</button>
      </div>
    </div>

  <div id="updateBanner" class="update-banner"><span>New version available</span><button id="reloadBtn">Reload</button></div>

    <main class="play-area">
      <div class="doodle" id="doodle">
        <!-- layered character composed of multiple same-size images (body, arms, drum, face).
             Images are centered and absolutely stacked so they align regardless of viewport. -->
        <div class="stack" id="figureStack" aria-hidden="false">
          <img id="bodyImg" src="public/images/body.png" alt="body" />
          <img id="armLeftImg" src="public/images/arm_left.png" alt="arm left" />
          <img id="armRightImg" src="public/images/arm_right.png" alt="arm right" />
          <img id="drumImg" src="public/images/drum.png" alt="drum" />
          <img id="drumTapImg" src="public/images/drum_tap.png" alt="drum tapped" style="opacity:0;pointer-events:none" />
          <!-- cymbal sits above the drum and above the character when purchased -->
          <img id="cymbalImg" src="public/images/cymbal.png" alt="cymbal" style="opacity:0.25" />
          <img id="cymbalTapImg" src="public/images/cymbal_tap.png" alt="cymbal tapped" style="opacity:0;pointer-events:none" />
          <img id="armLeftCymbalImg" src="public/images/arm_left_cymbal.png" alt="arm left cymbal" style="opacity:0;pointer-events:none" />
          <!-- snare sits above the drum and above the character when purchased -->
          <img id="snareImg" src="public/images/snare.png" alt="snare" style="opacity:0.25" />
          <img id="snareTapImg" src="public/images/snare_tap.png" alt="snare tapped" style="opacity:0;pointer-events:none" />
          <img id="armRightSnareImg" src="public/images/arm_right_snare.png" alt="arm right snare" style="opacity:0;pointer-events:none" />
          <!-- tom sits above the drum and above the character when purchased -->
          <img id="tomImg" src="public/images/tom.png" alt="tom" style="opacity:0.25" />
          <img id="tomTapImg" src="public/images/tom_tap.png" alt="tom tapped" style="opacity:0;pointer-events:none" />
          <img id="armLeftTomImg" src="public/images/arm_left_tom.png" alt="arm left tom" style="opacity:0;pointer-events:none" />
          <img id="armRightTomImg" src="public/images/arm_right_tom.png" alt="arm right tom" style="opacity:0;pointer-events:none" />
          <img id="face" class="face" src="public/images/face.png" alt="face" />
        </div>
      </div>
    </main>

    <div class="bottom">
      <div class="play-row" id="playRow">
        <div id="ownedPlayRow" style="display:flex;gap:8px;margin-left:4px"></div>
      </div>
    </div>
  </div>

  <div id="shopModal" class="modal">
    <div class="modal-card">
      <div style="display:flex;justify-content:space-between;align-items:center"><strong>Tienda</strong><button id="closeShop" class="shop-btn">Cerrar</button></div>
      <div class="items" id="itemsList"></div>
    </div>
  </div>

  <!-- Main application script -->
  <script type="module" src="scripts/main.js"></script>

  <script>
    // Register service worker for offline caching (if supported)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
  // register the service worker using a relative path so scope respects the current base
  navigator.serviceWorker.register('sw.js').then(reg => {
          console.log('Service worker registered:', reg.scope)

          const showUpdateBanner = () => {
            const banner = document.getElementById('updateBanner')
            const reloadBtn = document.getElementById('reloadBtn')
            if (!banner || !reloadBtn) return
            banner.style.display = 'flex'
            reloadBtn.onclick = () => {
              // Ask the waiting worker to skipWaiting and activate
              if (reg.waiting) reg.waiting.postMessage({ type: 'SKIP_WAITING' })
            }
          }

          // If there's already a waiting worker, show the banner
          if (reg.waiting) {
            showUpdateBanner()
          }

          // Listen for updates found (new service worker installing)
          reg.addEventListener('updatefound', () => {
            const inst = reg.installing
            inst.addEventListener('statechange', () => {
              if (inst.state === 'installed') {
                // A new SW is installed. If there's a controller, show update banner.
                if (navigator.serviceWorker.controller) showUpdateBanner()
              }
            })
          })

        }).catch(err => console.warn('SW registration failed:', err))

        // When a new service worker takes control, reload to use the new version
        navigator.serviceWorker.addEventListener('controllerchange', () => {
          window.location.reload()
        })
      })
    }

    // Note: Clear-cache debug button removed for security. To clear caches yourself:
    // 1) Open DevTools -> Application -> Service Workers -> Unregister the service worker.
    // 2) Application -> Storage -> Clear site data (this clears Cache Storage and Local Storage).
    // Or run this in the Console:
    // navigator.serviceWorker.getRegistrations().then(rs=>rs.forEach(r=>r.unregister())); caches.keys().then(ks=>Promise.all(ks.map(k=>caches.delete(k)))); localStorage.removeItem('halloween-rock:v1')
  </script>
</body>
</html>
